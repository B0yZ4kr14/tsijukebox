# =============================================================================
# TSiJUKEBOX Enterprise - Docker Compose Development
# Hot-reload enabled for development
# =============================================================================

version: '3.9'

services:
  # ---------------------------------------------------------------------------
  # Development Server with Hot Reload
  # ---------------------------------------------------------------------------
  app-dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: development
    container_name: tsijukebox-dev
    restart: unless-stopped
    ports:
      - "5173:5173"
    environment:
      - NODE_ENV=development
      - VITE_SUPABASE_URL=${VITE_SUPABASE_URL:-}
      - VITE_SUPABASE_PUBLISHABLE_KEY=${VITE_SUPABASE_PUBLISHABLE_KEY:-}
      - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:3000}
      - CHOKIDAR_USEPOLLING=true
    volumes:
      # Mount source code for hot-reload
      - ../src:/app/src:cached
      - ../public:/app/public:cached
      - ../index.html:/app/index.html:cached
      - ../vite.config.ts:/app/vite.config.ts:cached
      - ../tailwind.config.ts:/app/tailwind.config.ts:cached
      # Exclude node_modules
      - /app/node_modules
    networks:
      - tsijukebox-dev-network
    stdin_open: true
    tty: true
    labels:
      - "com.tsijukebox.env=development"

  # ---------------------------------------------------------------------------
  # Storybook (Optional - Component Development)
  # ---------------------------------------------------------------------------
  storybook:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: development
    container_name: tsijukebox-storybook
    ports:
      - "6006:6006"
    command: npm run storybook
    volumes:
      - ../src:/app/src:cached
      - ../stories:/app/stories:cached
      - /app/node_modules
    networks:
      - tsijukebox-dev-network
    profiles:
      - storybook
    labels:
      - "com.tsijukebox.service=storybook"

  # ---------------------------------------------------------------------------
  # Test Runner (Optional)
  # ---------------------------------------------------------------------------
  test:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: development
    container_name: tsijukebox-test
    command: npm run test -- --watch
    volumes:
      - ../src:/app/src:cached
      - /app/node_modules
    networks:
      - tsijukebox-dev-network
    profiles:
      - test
    labels:
      - "com.tsijukebox.service=test"

  # ---------------------------------------------------------------------------
  # E2E Tests with Playwright
  # ---------------------------------------------------------------------------
  e2e:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: development
    container_name: tsijukebox-e2e
    command: npx playwright test
    environment:
      - CI=true
    volumes:
      - ../e2e:/app/e2e:cached
      - ../playwright.config.ts:/app/playwright.config.ts:cached
      - /app/node_modules
    networks:
      - tsijukebox-dev-network
    depends_on:
      - app-dev
    profiles:
      - e2e
    labels:
      - "com.tsijukebox.service=e2e"

# =============================================================================
# Networks
# =============================================================================
networks:
  tsijukebox-dev-network:
    driver: bridge

# =============================================================================
# Development workflow commands:
# 
# Start development server:
#   docker-compose -f docker-compose.dev.yml up app-dev
#
# Run with Storybook:
#   docker-compose -f docker-compose.dev.yml --profile storybook up
#
# Run tests:
#   docker-compose -f docker-compose.dev.yml --profile test up
#
# Run E2E tests:
#   docker-compose -f docker-compose.dev.yml --profile e2e up
#
# Rebuild after dependency changes:
#   docker-compose -f docker-compose.dev.yml build --no-cache
# =============================================================================
