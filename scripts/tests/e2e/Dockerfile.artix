# TSiJUKEBOX Installer - Artix Linux Test Container
# ==================================================
# Container Artix Linux para testes E2E do instalador.
# Artix usa OpenRC/runit/s6 em vez de systemd.
#
# Build:
#   docker build -t tsijukebox-test-artix -f Dockerfile.artix ..
#
# Run:
#   docker run --rm -it tsijukebox-test-artix

# Artix é baseado em Arch mas sem systemd
FROM archlinux:latest

LABEL maintainer="TSiJUKEBOX Team"
LABEL description="Artix Linux-like test container for TSiJUKEBOX installer E2E tests"
LABEL distro="artix"
LABEL version="1.0.0"

# Simula ambiente Artix (sem systemd)
ENV DISTRO_NAME="Artix Linux"
ENV DISTRO_FAMILY="arch"
ENV DISTRO_ID="artix"
ENV INIT_SYSTEM="openrc"

# Atualiza sistema e instala dependências base
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm \
        python \
        python-pip \
        python-pytest \
        sudo \
        base-devel \
        git \
        curl \
        wget \
        which \
        procps-ng \
        iproute2 \
        nodejs \
        npm \
        sqlite \
        && \
    pacman -Scc --noconfirm

# Cria arquivo de release simulando Artix
RUN echo 'NAME="Artix Linux"' > /etc/os-release && \
    echo 'PRETTY_NAME="Artix Linux"' >> /etc/os-release && \
    echo 'ID=artix' >> /etc/os-release && \
    echo 'ID_LIKE=arch' >> /etc/os-release && \
    echo 'BUILD_ID=rolling' >> /etc/os-release && \
    echo 'HOME_URL="https://artixlinux.org/"' >> /etc/os-release && \
    echo 'LOGO=artixlinux' >> /etc/os-release

# Simula comandos OpenRC (stubs para testes)
RUN mkdir -p /etc/init.d /etc/runlevels/default

# Cria rc-service stub
RUN echo '#!/bin/bash' > /usr/local/bin/rc-service && \
    echo 'echo "rc-service: $@"' >> /usr/local/bin/rc-service && \
    echo 'exit 0' >> /usr/local/bin/rc-service && \
    chmod +x /usr/local/bin/rc-service

# Cria rc-update stub
RUN echo '#!/bin/bash' > /usr/local/bin/rc-update && \
    echo 'echo "rc-update: $@"' >> /usr/local/bin/rc-update && \
    echo 'exit 0' >> /usr/local/bin/rc-update && \
    chmod +x /usr/local/bin/rc-update

# Cria openrc stub
RUN echo '#!/bin/bash' > /usr/local/bin/openrc && \
    echo 'echo "openrc: $@"' >> /usr/local/bin/openrc && \
    echo 'exit 0' >> /usr/local/bin/openrc && \
    chmod +x /usr/local/bin/openrc

# Cria usuário de teste não-root
RUN useradd -m -s /bin/bash testuser && \
    echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    mkdir -p /home/testuser/.config && \
    mkdir -p /home/testuser/.local/share && \
    chown -R testuser:testuser /home/testuser

# Cria diretórios de trabalho
RUN mkdir -p /app/scripts /app/logs /app/data && \
    chown -R testuser:testuser /app

# Cria diretórios do TSiJUKEBOX
RUN mkdir -p /opt/tsijukebox /etc/tsijukebox /var/log/tsijukebox /var/lib/tsijukebox && \
    chown -R testuser:testuser /opt/tsijukebox /var/log/tsijukebox /var/lib/tsijukebox

# Configura variáveis de ambiente
ENV HOME=/home/testuser
ENV USER=testuser
ENV TSIJUKEBOX_TEST=1
ENV TSIJUKEBOX_DISTRO=artix
ENV PYTHONPATH=/app/scripts
ENV PATH="/home/testuser/.local/bin:${PATH}"

# Copia scripts
WORKDIR /app/scripts
COPY . /app/scripts/

# Ajusta permissões
RUN chown -R testuser:testuser /app && \
    chmod +x /app/scripts/*.py 2>/dev/null || true

# Instala dependências Python
RUN pip install --break-system-packages \
    pytest \
    pytest-mock \
    pytest-benchmark \
    pytest-timeout \
    || pip install \
    pytest \
    pytest-mock \
    pytest-benchmark \
    pytest-timeout

# Artix usa paru/yay como AUR helpers
RUN echo '#!/bin/bash' > /usr/local/bin/paru && \
    echo 'exec pacman "$@"' >> /usr/local/bin/paru && \
    chmod +x /usr/local/bin/paru

RUN echo '#!/bin/bash' > /usr/local/bin/yay && \
    echo 'exec pacman "$@"' >> /usr/local/bin/yay && \
    chmod +x /usr/local/bin/yay

# Troca para usuário de teste
USER testuser

# Healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python3 -c "print('healthy')" || exit 1

# Comando padrão
CMD ["python3", "-m", "pytest", "tests/", "-v", "--tb=short", "-m", "not docker"]
