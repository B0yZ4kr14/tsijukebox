# TSiJUKEBOX Installer - EndeavourOS Test Container
# =================================================
# Container EndeavourOS para testes E2E do instalador.
#
# Build:
#   docker build -t tsijukebox-test-endeavouros -f Dockerfile.endeavouros ..
#
# Run:
#   docker run --rm -it tsijukebox-test-endeavouros

# EndeavourOS é baseado em Arch Linux
FROM archlinux:latest

LABEL maintainer="TSiJUKEBOX Team"
LABEL description="EndeavourOS-like test container for TSiJUKEBOX installer E2E tests"
LABEL distro="endeavouros"
LABEL version="1.0.0"

# Simula ambiente EndeavourOS
ENV DISTRO_NAME="EndeavourOS"
ENV DISTRO_FAMILY="arch"
ENV DISTRO_ID="endeavouros"

# Atualiza sistema e instala dependências base
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm \
        python \
        python-pip \
        python-pytest \
        sudo \
        base-devel \
        git \
        curl \
        wget \
        which \
        procps-ng \
        iproute2 \
        nodejs \
        npm \
        sqlite \
        && \
    pacman -Scc --noconfirm

# Cria arquivo de release simulando EndeavourOS
RUN echo 'NAME="EndeavourOS"' > /etc/os-release && \
    echo 'PRETTY_NAME="EndeavourOS"' >> /etc/os-release && \
    echo 'ID=endeavouros' >> /etc/os-release && \
    echo 'ID_LIKE=arch' >> /etc/os-release && \
    echo 'BUILD_ID=rolling' >> /etc/os-release && \
    echo 'HOME_URL="https://endeavouros.com/"' >> /etc/os-release && \
    echo 'LOGO=endeavouros' >> /etc/os-release

# Cria usuário de teste não-root
RUN useradd -m -s /bin/bash testuser && \
    echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    mkdir -p /home/testuser/.config && \
    mkdir -p /home/testuser/.local/share && \
    chown -R testuser:testuser /home/testuser

# Cria diretórios de trabalho
RUN mkdir -p /app/scripts /app/logs /app/data && \
    chown -R testuser:testuser /app

# Cria diretórios do TSiJUKEBOX
RUN mkdir -p /opt/tsijukebox /etc/tsijukebox /var/log/tsijukebox /var/lib/tsijukebox && \
    chown -R testuser:testuser /opt/tsijukebox /var/log/tsijukebox /var/lib/tsijukebox

# Configura variáveis de ambiente
ENV HOME=/home/testuser
ENV USER=testuser
ENV TSIJUKEBOX_TEST=1
ENV TSIJUKEBOX_DISTRO=endeavouros
ENV PYTHONPATH=/app/scripts
ENV PATH="/home/testuser/.local/bin:${PATH}"

# Copia scripts
WORKDIR /app/scripts
COPY . /app/scripts/

# Ajusta permissões
RUN chown -R testuser:testuser /app && \
    chmod +x /app/scripts/*.py 2>/dev/null || true

# Instala dependências Python
RUN pip install --break-system-packages \
    pytest \
    pytest-mock \
    pytest-benchmark \
    pytest-timeout \
    || pip install \
    pytest \
    pytest-mock \
    pytest-benchmark \
    pytest-timeout

# EndeavourOS usa yay como AUR helper padrão
RUN echo '#!/bin/bash' > /usr/local/bin/yay && \
    echo 'exec pacman "$@"' >> /usr/local/bin/yay && \
    chmod +x /usr/local/bin/yay

# Também simula paru
RUN echo '#!/bin/bash' > /usr/local/bin/paru && \
    echo 'exec pacman "$@"' >> /usr/local/bin/paru && \
    chmod +x /usr/local/bin/paru

# Troca para usuário de teste
USER testuser

# Healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python3 -c "print('healthy')" || exit 1

# Comando padrão
CMD ["python3", "-m", "pytest", "tests/", "-v", "--tb=short", "-m", "not docker"]
