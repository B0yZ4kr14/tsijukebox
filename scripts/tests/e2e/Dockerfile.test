# TSiJUKEBOX Installer - Test Container
# =====================================
# Container Arch Linux para testes E2E do instalador.
#
# Build:
#   docker build -t tsijukebox-installer-test -f Dockerfile.test ..
#
# Run:
#   docker run --rm -it tsijukebox-installer-test

FROM archlinux:latest

LABEL maintainer="TSiJUKEBOX Team"
LABEL description="Test container for TSiJUKEBOX installer E2E tests"
LABEL version="1.0.0"

# Atualiza sistema e instala dependências base
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm \
        python \
        python-pip \
        python-pytest \
        sudo \
        base-devel \
        git \
        curl \
        wget \
        which \
        procps-ng \
        iproute2 \
        && \
    pacman -Scc --noconfirm

# Cria usuário de teste não-root
RUN useradd -m -s /bin/bash testuser && \
    echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    mkdir -p /home/testuser/.config && \
    chown -R testuser:testuser /home/testuser

# Cria diretórios de trabalho
RUN mkdir -p /app/scripts /app/logs /app/data && \
    chown -R testuser:testuser /app

# Configura variáveis de ambiente
ENV HOME=/home/testuser
ENV USER=testuser
ENV TSIJUKEBOX_TEST=1
ENV PYTHONPATH=/app/scripts
ENV PATH="/home/testuser/.local/bin:${PATH}"

# Copia scripts (será sobrescrito por volume em runtime)
WORKDIR /app/scripts
COPY . /app/scripts/

# Ajusta permissões
RUN chown -R testuser:testuser /app && \
    chmod +x /app/scripts/*.py 2>/dev/null || true

# Instala dependências Python
RUN pip install --break-system-packages \
    pytest \
    pytest-mock \
    pytest-benchmark \
    pytest-timeout \
    || pip install \
    pytest \
    pytest-mock \
    pytest-benchmark \
    pytest-timeout

# Troca para usuário de teste
USER testuser

# Healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python3 -c "print('healthy')" || exit 1

# Comando padrão
CMD ["python3", "-m", "pytest", "tests/", "-v", "--tb=short"]

# Comandos alternativos úteis:
# - Dry run do instalador:
#   docker run --rm tsijukebox-installer-test python3 unified-installer.py --dry-run
#
# - Shell interativo:
#   docker run --rm -it tsijukebox-installer-test /bin/bash
#
# - Apenas testes unitários:
#   docker run --rm tsijukebox-installer-test python3 -m pytest tests/test_unified_installer.py -v
